% encoding and microtype
\usepackage[T1]{fontenc}
\usepackage[activate={true,nocompatibility},tracking=true,kerning=true,spacing=false,factor=1100,stretch=10,shrink=10]{microtype}
\microtypecontext{spacing=nonfrench}

% core utilities
\usepackage{listings}
\usepackage{xcolor}
\usepackage{import}
\usepackage{etoolbox}
\usepackage{cprotect}
\usepackage{textcomp}
\usepackage{calc}

% math packages
\usepackage{amsmath}
\usepackage{mathtools}
\usepackage{amsthm}
\usepackage{amssymb}
\usepackage{mathrsfs}
\usepackage{dsfont}
\usepackage{latexsym}
\usepackage{siunitx}
\usepackage{nicefrac}
\usepackage{cancel}
\usepackage{algorithm}
\usepackage{algpseudocode}

% fonts
\usepackage{libertine}
\usepackage[libertine]{newtxmath}
\usepackage[varqu,scaled=0.95]{inconsolata}

% layout
\usepackage[margin=1in,bindingoffset=0.5cm,headheight=15pt,twoside,marginparwidth=0.8in,marginparsep=0.1in]{geometry}
\usepackage{setspace}
\usepackage{multicol}
\usepackage{multirow}
\usepackage{dcolumn}
\usepackage{varwidth}
\usepackage{tabularx}
\usepackage{booktabs}
\usepackage{array}
\usepackage{ragged2e}
\usepackage{float}
\usepackage{rotating}
\usepackage{wrapfig}
\usepackage{boxedminipage}
\usepackage{fancybox}
\usepackage[all]{nowidow}
\usepackage{titlesec}
\usepackage{epigraph}
\usepackage{lettrine}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{mparhack}
\usepackage{marginnote}

% graphics
\usepackage{graphicx}
\usepackage{pifont}
\usepackage{tikz}
\usepackage{pgfplots}
\usepackage[most]{tcolorbox}

% colors
\definecolor{airforceblue}{RGB}{93,138,168}
\definecolor{darkblue}{rgb}{0.0,0.0,0.55}
\definecolor{cream}{rgb}{1.0,0.99,0.82}
\definecolor{islamicgreen}{rgb}{0.0,0.56,0.0}
\definecolor{thmcolor}{rgb}{0.96,0.92,0.86}
\definecolor{defncolor}{rgb}{0.93,0.96,0.98}
\definecolor{tipcolor}{rgb}{0.94,0.97,0.94}
\definecolor{warncolor}{rgb}{0.98,0.94,0.94}
\definecolor{corcolor}{rgb}{0.96,0.94,0.98}
\definecolor{datacol}{rgb}{0.8,0.33,0.0}
\definecolor{packcol}{rgb}{0.09,0.45,0.27}
\definecolor{methcol}{rgb}{0.16,0.32,0.75}
\definecolor{incol}{rgb}{0.80,0.91,0.98}
\definecolor{outcol}{gray}{0.9}
\definecolor{codekey}{rgb}{0.0,0.0,1.0}
\definecolor{codecomment}{rgb}{0.0,0.6,0.0}
\definecolor{codestring}{rgb}{0.58,0.0,0.82}

% headers
\usepackage{fancyhdr}
\setlength{\headheight}{15pt}

\newcommand{\cornerpagenum}{%
	\begin{tikzpicture}[baseline=(n.base)]
		\node(n)[inner sep=4pt,font=\small\bfseries] {\thepage};
		\draw[airforceblue,thin] (n.north east) -- (n.north west) -- (n.south west);
	\end{tikzpicture}%
}

\pagestyle{fancy}
\fancyhf{}
\renewcommand{\headrulewidth}{0.4pt}

% section sets left mark and clears right mark (no fallback)
\renewcommand{\sectionmark}[1]{\markboth{\thesection\quad #1}{}}
% subsection sets right mark only
\renewcommand{\subsectionmark}[1]{\markright{\thesubsection\quad #1}}

% static placement: section left subsection right
\fancyhead[L]{\scshape\nouppercase{\leftmark}}
\fancyhead[R]{\bfseries\nouppercase{\rightmark}}
\fancyfoot[R]{\cornerpagenum}

% plain style
\fancypagestyle{plain}{
	\fancyhf{}
	\renewcommand{\headrulewidth}{0pt}
	\fancyfoot[R]{\cornerpagenum}
}

% references
\usepackage{hyperref}
\usepackage{xurl}
\usepackage[nameinlink]{cleveref}
\usepackage[shortlabels]{enumitem}
\usepackage[acronym,toc,nonumberlist]{glossaries}
\usepackage[style=authoryear,backend=biber,natbib=true,doi=true]{biblatex}

% tikz config
\pgfplotsset{compat=1.18}
\usepgfplotslibrary{external,fillbetween}
\tcbset{shield externalize}
\usetikzlibrary{matrix,calc,positioning,arrows.meta,intersections,chains,shapes.geometric,patterns,fpu}

% titles
\titlespacing*{\part}{0pt}{0pt}{0pt}
\newcommand{\sectionbreak}{\clearpage}
\titleformat{\section}{\singlespacing\color{darkblue}\normalfont\Large\bfseries}{\thesection}{1em}{} % chktex 1
\titlespacing*{\section}{0pt}{1.5ex plus 1ex minus .2ex}{1ex plus .2ex}
\titleformat{\subsection}{\singlespacing\color{darkblue}\normalfont\large\bfseries}{\thesubsection}{1em}{} % chktex 1
\titlespacing*{\subsection}{0pt}{1.5ex plus 1ex minus .2ex}{0.8ex plus .2ex}
\titleformat{\subsubsection}{\singlespacing\color{darkblue}\normalfont\normalsize\bfseries}{\thesubsubsection}{1em}{} % chktex 1
\titlespacing*{\subsubsection}{0pt}{1.5ex plus 1ex minus .2ex}{0.8ex plus .2ex}
\setcounter{secnumdepth}{5}
\setcounter{tocdepth}{5}

% macros
\DeclarePairedDelimiter\abs{\lvert}{\rvert}
\DeclarePairedDelimiter\norm{\lVert}{\rVert}
\DeclarePairedDelimiter\bra{\langle}{\rvert}
\DeclarePairedDelimiter\ket{\lvert}{\rangle}
\DeclarePairedDelimiterX\braket[2]{\langle}{\rangle}{#1 \delimsize\vert #2}
\DeclarePairedDelimiterX\inner[2]{\langle}{\rangle}{#1, #2}
\DeclarePairedDelimiter\set{\{}{\}}

\newcommand{\bb}[1]{\mathbb{#1}}
\newcommand{\vect}[1]{\boldsymbol{#1}}
\renewcommand{\v}[1]{\boldsymbol{#1}}
\newcommand{\mathem}[1]{\(\boldsymbol{#1}\)}
\newcommand{\T}{\top}
\newcommand{\indsim}{\stackrel{\mathrm{ind}}{\sim}}
\newcommand{\iidsim}{\stackrel{\mathrm{iid}}{\sim}}
\newcommand{\distreq}{\stackrel{d}{=}}
\let\simind\indsim \let\simiid\iidsim \let\eqdistr\distreq
\newcommand{\gvn}{\,|\,}
\newcommand{\e}{\mathrm{e}}
\newcommand{\I}{\mathds{1}}

% distributions
\newcommand{\Ber}{\mathsf{Ber}} \let\ber\Ber
\newcommand{\Bin}{\mathsf{Bin}} \let\bin\Bin
\newcommand{\NegBin}{\mathsf{NegBin}} \let\negbin\NegBin \let\nbin\NegBin \let\Nbin\NegBin
\newcommand{\Geo}{\mathsf{Geom}} \let\geo\Geo \let\Geom\Geo
\newcommand{\Poi}{\mathsf{Poi}} \let\poi\Poi \let\Po\Poi
\newcommand{\Exp}{\mathsf{Exp}} \let\ex\Exp
\newcommand{\Nor}{\EuScript{N}} \let\nor\Nor
\newcommand{\Gam}{\mathsf{Gamma}} \let\gam\Gam
\newcommand{\Bet}{\mathsf{Beta}} \let\bet\Bet
\newcommand{\Cauchy}{\mathsf{Cauchy}} \let\cauchy\Cauchy
\newcommand{\Laplace}{\mathsf{Laplace}} \let\laplace\Laplace
\newcommand{\Dir}{\mathsf{Dirichlet}} \let\dir\Dir
\newcommand{\Wishart}{\mathsf{Wishart}}
\newcommand{\Pareto}{\mathsf{Pareto}} \let\pareto\Pareto
\newcommand{\Weib}{\mathsf{Weib}} \let\weib\Weib
\newcommand{\Gumbel}{\mathsf{Gumbel}} \let\gumbel\Gumbel
\newcommand{\Frechet}{\text{\sf Fr\'{e}chet}} \let\frechet\Frechet
\newcommand{\Wald}{\mathsf{Wald}} \let\InvGauss\Wald
\newcommand{\Logistic}{\mathsf{Logistic}} \let\logistic\Logistic
\newcommand{\Student}{\mathsf{t}} \let\student\Student
\newcommand{\Mnom}{\mathsf{Mnom}} \let\mnom\Mnom
\newcommand{\Unif}{\EuScript{U}} \let\U\Unif

% helpers
\newcommand{\code}[1]{{\normalfont\ttfamily\hyphenchar\font=-1 #1}}
\newcommand{\file}[1]{\texttt{#1}}
\newcommand{\dataset}[1]{\texttt{#1}}
\newcommand{\package}[1]{\texttt{\textcolor{packcol}{#1}}}
\newcommand{\method}[1]{\texttt{\textcolor{methcol}{#1}}}
\newcommand{\query}[1]{\marginpar{\vspace*{5pt}\fbox{\parbox{0.9\marginparwidth}{\scriptsize\sffamily\raggedright\textcolor{red}{\textbf{AQ:}} #1}}}}
\newcommand{\mnote}[2]{\marginnote{\setlength{\parskip}{2pt}\raggedright\textcolor{airforceblue}{\textbf{#1}}\\[2pt]\color{black!85} #2}[0cm]}

% styles
\tcbset{
	academicbox/.style={
			enhanced,colframe=black!35!black,coltitle=white,fonttitle=\bfseries,
			colbacktitle=black!35!black,boxed title style={sharp corners=north,rounded corners=south},
			boxrule=0.6mm,drop fuzzy shadow,separator sign={:},
			before skip=12pt,after skip=12pt
		}
}

% listings style definition
\lstdefinestyle{pythonstyle}{
	language=Python,
	basicstyle=\footnotesize\ttfamily,
	numbers=left,
	numberstyle=\tiny\color{blue},
	stepnumber=1,
	numbersep=7pt,
	backgroundcolor=\color{cream},
	rulecolor=\color{black},
	tabsize=2,
	breaklines=true,
	keywordstyle=\color{blue},
	commentstyle=\color{islamicgreen},
	stringstyle=\color{red},
	upquote=true,
	morekeywords={np,random,seed,sqrt,randn,linspace,r_,cumsum,exp,cumprod,reshape,axis}
}

% theorems
\newtcbtheorem[auto counter,number within=section]{thm}{Theorem}{academicbox,colback=thmcolor,fontupper=\itshape}{thm}
\newtcbtheorem[auto counter,number within=section]{cor}{Corollary}{academicbox,colback=corcolor,fontupper=\itshape}{cor}
\newtcbtheorem[auto counter,number within=section]{lem}{Lemma}{academicbox,colback=thmcolor!70!white,fontupper=\itshape}{lem}
\newtcbtheorem[auto counter,number within=section]{prop}{Proposition}{academicbox,colback=thmcolor!50!white,fontupper=\itshape}{prop}
\newtcbtheorem[auto counter,number within=section]{defn}{Definition}{academicbox,colback=defncolor,colframe=airforceblue,colbacktitle=airforceblue,fontupper=\upshape}{defn}

% referencing aliases for tcolorbox counters
\crefname{tcb@cnt@thm}{Theorem}{Theorems}
\crefname{tcb@cnt@cor}{Corollary}{Corollaries}
\crefname{tcb@cnt@lem}{Lemma}{Lemmas}
\crefname{tcb@cnt@prop}{Proposition}{Propositions}
\crefname{tcb@cnt@defn}{Definition}{Definitions}

% alerts
\newtcolorbox{xattention}{
	enhanced,breakable,colback=warncolor,colframe=black!35!black,
	drop shadow,arc=5mm,sharp corners=uphill,
	boxed title style={empty},
	overlay={\node[anchor=west,xshift=-10mm] at (frame.west) {\Huge\ding{43}};}
}
\newtcolorbox{xtip}{
	enhanced,breakable,colback=tipcolor,colframe=black!35!black,
	drop shadow,arc=5mm,sharp corners=uphill,
	boxed title style={empty},
	overlay={\node[anchor=west,xshift=-10mm] at (frame.west) {\Huge\ding{45}};}
}

% python boxes
\newtcblisting{Pcode}[1]{
	breakable,listing only,colback=cream,colframe=red!5!black,
	colbacktitle=black,enhanced,attach boxed title to top center={xshift=-3cm,yshift=-2mm},
	arc=0mm,title={{\ttfamily\large #1}},
	listing options={style=pythonstyle}
}

\newtcblisting{PC}{
	breakable,listing only,colback=cream,enhanced,sharpish corners,boxrule=1pt,
	listing options={style=pythonstyle,numbers=none,xleftmargin=-10pt,aboveskip=-4pt,belowskip=-6pt}
}

\newtcblisting{PC1}[2]{
	breakable,listing only,colback=cream,enhanced,
	attach boxed title to top left={yshift=-0.5mm},
	title={\href{#1}{\ttfamily #2}},
	sharpish corners,boxrule=1pt,
	listing options={style=pythonstyle,numbers=none,xleftmargin=-10pt,aboveskip=-4pt,belowskip=-6pt}
}

% legacy pin and pout
\lstnewenvironment{Pin}{%
	\lstset{
		backgroundcolor=\color{incol},
		belowskip=0pt,
		xleftmargin=3pt,
		xrightmargin=3pt,
		frame=single,
		framerule=0pt,
		basicstyle=\footnotesize\ttfamily,
		columns=fixed
	}
}{}

\lstnewenvironment{Pout}{%
	\lstset{
		backgroundcolor=\color{outcol},
		aboveskip=-2pt,
		xleftmargin=4pt,
		xrightmargin=4pt,
		frame=single,
		upquote,
		framerule=1pt,
		basicstyle=\footnotesize\ttfamily,
		columns=fixed
	}
}{}
